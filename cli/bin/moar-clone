#!/bin/bash

set -e

mkdir -p ~/moar-workspace

dir=`pwd`

if [ -h ${dir}/$1 ]; then
  rm ${dir}/$1
fi

if [ -d ~/moar-workspace/$1 ]; then
  cd ~/moar-workspace/$1
  git rev-parse HEAD > ${dir}/moar-modules/init-$1
else
  cd ~/moar-workspace
  git clone `cat "$dir/moar-modules/git-$1"`
  cd $1
  git reset --hard `cat "$dir/moar-modules/init-$1"`
  git rev-parse HEAD > ${dir}/moar-modules/init-$1
  moar-init
  cd ${dir}
fi

ln -s ~/moar-workspace/$1 ${dir}/$1